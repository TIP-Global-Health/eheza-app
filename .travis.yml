sudo: required

language: php

php:
- 7.2

services:
- docker

stages:
  - lint
  - test
  - deploy

before_install:
- export PATH="$HOME/.config/composer/vendor/bin:$HOME/vendor/bin:$PATH"
# Here we switch to a Google-powered Docker image mirror.
# There were often failures and very long retry loops with
# the built-in registry mirror provided by Docker.
- tmpdaemon=$(mktemp)
- sudo jq '."registry-mirrors" = ["https://docker.gizra.com"]' /etc/docker/daemon.json > $tmpdaemon
- sudo mv $tmpdaemon /etc/docker/daemon.json
- sudo systemctl daemon-reload
- sudo systemctl restart docker

jobs:
  include:
    - stage: Lint
      name: "Drupal coding standard: PhpCs"
      env:
        - REVIEW_STANDARD="Drupal"
      script:
        - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh"
        - "$TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh"
    - stage: Lint
      name: "Drupal Practice coding standard: PhpCs"
      env:
        - REVIEW_STANDARD="DrupalPractice"
      script:
        - "$TRAVIS_BUILD_DIR/ci-scripts/install_coder.sh"
        - "$TRAVIS_BUILD_DIR/ci-scripts/test_coder.sh"
    - stage: Lint
      name: "Elm coding standard: Elm Format"
      script:
        - "$TRAVIS_BUILD_DIR/ci-scripts/install_elm_format.sh"
        - "$TRAVIS_BUILD_DIR/ci-scripts/test_elm_format.sh"
    - stage: Lint
      name: "Drupal coding standard: Shellcheck"
      script:
        - "$TRAVIS_BUILD_DIR/ci-scripts/install_shell.sh"
        - "$TRAVIS_BUILD_DIR/ci-scripts/test_shell.sh"
    - stage: Test
      name: "Server-side"
      script:
        - "$TRAVIS_BUILD_DIR/ci-scripts/install_server.sh"
        - "$TRAVIS_BUILD_DIR/ci-scripts/test_server.sh"

cache:
  directories:
  - travis-cache
  - vendor
