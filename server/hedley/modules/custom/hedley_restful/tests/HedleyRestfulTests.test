<?php

/**
 * @file
 * Contains \HedleyRestfulTests.
 */

/**
 * HedleyRestfulTests tests.
 */
class HedleyRestfulTests extends HedleyWebTestBase {

  /**
   * Info hook.
   */
  public static function getInfo() {
    return [
      'name' => 'HedleyRestfulTests tests',
      'description' => 'Tests restful endpoints.',
      'group' => 'Hedley',
    ];
  }

  /**
   * Create a nurse user, assigned to the indicated clinic.
   *
   * @param int $clinic_id
   *   The node ID of the clinic the nurse is assigned to.
   *
   * @return \StdClass
   *   The user.
   */
  public function createNurse($clinic_id) {
    $account = $this->drupalCreateUser();

    $role = user_role_load_by_name('nurse');
    user_multiple_role_edit([$account->uid], "add role", $role->rid);

    $wrapper = entity_metadata_wrapper('user', $account);
    $wrapper->field_clinics->set([$clinic_id]);
    $wrapper->save();

    return $account;
  }

  /**
   * Create a clinic with a random name.
   *
   * @return int
   *   The node ID.
   */
  public function createClinic() {
    return $this->drupalCreateNode([
      'type' => 'clinic',
    ]);
  }

  /**
   * Create a mother.
   *
   * @param string $name
   *   The mother's name.
   * @param string $clinic_id
   *   The clinic to assign the mother to.
   *
   * @return int
   *   The node ID of the mother.
   */
  public function createMother($name, $clinic_id) {
    $node = $this->drupalCreateNode([
      'type' => 'mother',
      'title' => $name,
    ]);

    $wrapper = entity_metadata_wrapper('node', $node);
    $wrapper->field_date_birth->set(strtotime('1998-07-01'));
    $wrapper->field_clinic->set($clinic_id);
    $wrapper->field_ubudehe->set(1);
    $wrapper->field_education_level->set(2);
    $wrapper->save();

    return $node->nid;
  }

  /**
   * Create a child.
   *
   * @param string $name
   *   The child's name.
   * @param int $mother_id
   *   The mother's node ID.
   *
   * @return int
   *   The child's node ID.
   */
  public function createChild($name, $mother_id) {
    $child = $this->drupalCreateNode([
      'type' => 'child',
      'title' => $name,
    ]);

    $child_wrapper = entity_metadata_wrapper('node', $child);
    $child_wrapper->field_mother->set($mother_id);
    $child_wrapper->field_date_birth->set(strtotime('2015-06-27'));
    $child_wrapper->field_gender->set('male');
    $child_wrapper->save();

    return $child->nid;
  }

  /**
   * Create a session for the clinic, starting today.
   *
   * @param int $clinic_id
   *   The node ID of the clinic.
   *
   * @return int
   *   The node ID of the session.
   */
  public function createSession($clinic_id) {
    $today = date('Y-m-d');

    $session = $this->drupalCreateNode(['type' => 'session']);

    $session_wrapper = entity_metadata_wrapper('node', $session);
    $session_wrapper->field_clinic->set($clinic_id);
    $session_wrapper->field_scheduled_date->set([
      'value' => $today,
      'value2' => $today,
    ]);
    $session_wrapper->field_closed->set(FALSE);
    $session_wrapper->save();

    return $session->nid;
  }

  /**
   * Tests downloading an offiline session.
   */
  public function testDownloadOfflineSession() {
    // Create a clinic, a session, and a nurse.
    $clinic_id = $this->createClinic();
    $nurse = $this->createNurse($clinic_id);
    $session_id = $this->createSession($clinic_id);

    // Create a whole bunch of things, to test that we actually
    // get all of them with our batched queries.
    for ($x = 0; $x < 75; $x++) {
      // For the code that gets mothers for the session's particular clinic.
      $mother_id = $this->createMother($this->randomName(), $clinic_id);

      // Give each mother two children.
      $this->createChild($this->randomName(), $mother_id);
      $this->createChild($this->randomName(), $mother_id);

      // For the code that sends basic data for all clinics.
      $other_clinic_id = $this->createClinic();

      // Add a mother and some children for the other clinics, to test
      // that we **don't** get those.
      $other_mother_id = $this->createMother($this->randomName(), $other_clinic_id);
      $this->createChild($this->randomName(), $other_mother_id);

      // Add a session for each clinic.
      $this->createSession($other_clinic_id);
    }

    $handler = restful_get_restful_handler('offline_sessions');
    $handler->setAccount($nurse);

    $results = $handler->get($session_id);
    $data = $results[0];

    $this->assertEqual($data['id'], $session_id);
    $this->assertEqual(count($data['clinics']), 76);
    $this->assertEqual(count($data['participants']['mothers']), 75);
    $this->assertEqual(count($data['participants']['children']), 150);
    $this->assertEqual(count($data['all_sessions']), 76);
  }

  /**
   * Tests downloading an offiline session for a clinic that has no mothers.
   */
  public function testDownloadOfflineSessionWithoutMothers() {
    $clinic_id = $this->createClinic();
    $nurse = $this->createNurse($clinic_id);
    $session_id = $this->createSession($clinic_id);

    $handler = restful_get_restful_handler('offline_sessions');
    $handler->setAccount($nurse);

    $results = $handler->get($session_id);
    $this->assertEqual($results[0]['id'], $session_id);
  }

}
