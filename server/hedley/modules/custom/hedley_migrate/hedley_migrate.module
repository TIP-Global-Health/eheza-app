<?php

/**
 * @file
 * Populate Hedley content.
 */

use Faker\Generator;

/**
 * Implements hook_migrate_api().
 */
function hedley_migrate_migrate_api() {
  $api = [
    'api' => 2,
    'groups' => [
      'missing' => [
        'title' => t('Missing Data'),
      ],
    ],
    'migrations' => [
      'HedleyMigrateUsers' => [
        'class_name' => 'HedleyMigrateUsers',
      ],
      'HedleyMigrateClinics' => [
        'class_name' => 'HedleyMigrateClinics',
      ],
      'HedleyMigrateMissingHeights' => [
        'class_name' => 'HedleyMigrateMissingHeights',
        'group_name' => 'missing',
      ],
      'HedleyMigrateMissingWeights' => [
        'class_name' => 'HedleyMigrateMissingWeights',
        'group_name' => 'missing',
      ],
      'HedleyMigrateMissingMuacs' => [
        'class_name' => 'HedleyMigrateMissingMuacs',
        'group_name' => 'missing',
      ],
    ],
  ];

  return $api;
}

/**
 * Implements hook_hedley_faker_node_generate().
 */
function hedley_migrate_hedley_faker_node_generate($node, Generator $faker) {
  if (!$node->uid) {
    // User can't be anonymous, get a random user(not admin or anonymous).
    $query = new EntityFieldQuery();
    $result = $query
      ->entityCondition('entity_type', 'user')
      ->propertyCondition('uid', [0, 1], 'NOT IN')
      ->range(0, 200)
      ->execute();

    $node->uid = array_rand($result['user']);
  }

  $node->title = $faker->sentence(6);

  switch ($node->type) {
    case 'child':
      _hedley_migrate_preprocess_child($node, $faker);
      break;

    case 'mother':
      _hedley_migrate_preprocess_mother($node, $faker);
      break;

    case 'weight':
      _hedley_migrate_preprocess_weight($node);
      break;

    case 'height':
      _hedley_migrate_preprocess_height($node);
      break;

    case 'muac':
      _hedley_migrate_preprocess_muac($node);
      break;
  }

  // Adjust XSS.
  _hedley_migrate_preprocess_xss('node', $node->type, $node);
}

/**
 * Implements hook_hedley_faker_taxonomy_term_generate().
 */
function hedley_migrate_hedley_faker_taxonomy_term_generate($term, Generator $faker) {
  $term->name = $faker->sentence(2);

  // Adjust XSS.
  _hedley_migrate_preprocess_xss('taxonomy_term', $term->vocabulary_machine_name, $term);
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * We should have at least one entity from each bundle with an XSS label.
 *
 * @param string $entity_type
 *   The entity type to alter.
 * @param string $bundle
 *   The bundle of the entity.
 * @param object $entity
 *   Site entity object.
 */
function _hedley_migrate_preprocess_xss($entity_type, $bundle, $entity) {
  // This global var keeps xss indication for each entity type / bundle.
  $_hedley_devel_generate = &drupal_static(__FUNCTION__, []);

  if (!$entity_info = entity_get_info($entity_type)) {
    return;
  }

  $label_property = $entity_info['entity keys']['label'];

  // Validate the current node type has at least one instance with XSS.
  $xss_is_missing = empty($_hedley_devel_generate[$entity_type][$bundle]);

  $randomly_add_xss = rand() % 2 == 0;
  if (!$xss_is_missing && $randomly_add_xss) {
    return;
  }

  // Indicate the current bundle has an XSS instance.
  $_hedley_devel_generate[$entity_type][$bundle] = TRUE;

  $wrapper = entity_metadata_wrapper($entity_type, $entity);

  // Adjust node's title to include XSS.
  $label = $wrapper->label();
  $wrapper->{$label_property}->set("<script>alert('XSS-{$entity_type}-{$bundle}-{$label}')</script>");

  // Handle all text fields.
  foreach (field_info_instances($entity_type, $bundle) as $field_name => $field) {
    $field = field_info_field($field_name);
    if ($field['module'] != 'text') {
      continue;
    }

    $wrapper->{$field_name}->set("<script>alert('XSS-{$entity_type}-{$bundle}-{$field_name}')</script>");
  }
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * @param object $node
 *   Site node object.
 * @param \Faker\Generator $faker
 *   The faker generator object.
 */
function _hedley_migrate_preprocess_child($node, Generator $faker) {
  $wrapper = entity_metadata_wrapper('node', $node);

  $helpers = _hedley_migrate_participant_helpers();

  $gender = $helpers['gender'][$faker->numberBetween(0, count($helpers['gender']) - 1)];
  $wrapper->field_gender->set($gender);

  $first_name = $gender == 'male' ? $faker->firstNameMale : $faker->firstNameFemale;
  $second_name = $faker->lastName;
  $wrapper->title->set("$first_name $second_name");
  $wrapper->field_first_name->set($first_name);
  $wrapper->field_second_name->set($second_name);

  $mode_of_delivery = [
    'svd-episiotomy',
    'svd-no-episiotomy',
    'vd-vacuum',
    'cesarean-delivery',
  ];
  $wrapper->field_mode_of_delivery->set($mode_of_delivery[$faker->numberBetween(0, count($mode_of_delivery) - 1)]);

  $geolocation_info = $helpers['geolocation_info'][$faker->numberBetween(0, count($helpers['geolocation_info']) - 1)];
  $wrapper->field_province->set($geolocation_info[0]);
  $wrapper->field_district->set($geolocation_info[1]);
  $wrapper->field_sector->set($geolocation_info[2]);
  $wrapper->field_cell->set($geolocation_info[3]);
  $wrapper->field_village->set($geolocation_info[4]);

  $wrapper->field_phone_number->set($faker->phoneNumber);

  $_hedley_devel_generate = &drupal_static(__FUNCTION__, FALSE);

  if ($_hedley_devel_generate) {
    return;
  }

  $_hedley_devel_generate = TRUE;
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * @param object $node
 *   Site node object.
 * @param \Faker\Generator $faker
 *   The faker generator object.
 */
function _hedley_migrate_preprocess_mother($node, Generator $faker) {
  $wrapper = entity_metadata_wrapper('node', $node);

  $helpers = _hedley_migrate_participant_helpers();

  $gender = $helpers['gender'][$faker->numberBetween(0, count($helpers['gender']) - 1)];
  $wrapper->field_gender->set($gender);

  $first_name = $gender == 'male' ? $faker->firstNameMale : $faker->firstNameFemale;
  $second_name = $faker->lastName;
  $wrapper->title->set("$first_name $second_name");
  $wrapper->field_first_name->set($first_name);
  $wrapper->field_second_name->set($second_name);
  $wrapper->field_national_id_number->set($faker->numberBetween(1000, 9999));
  $wrapper->field_profession->set($faker->jobTitle);

  $marital_status = ['divorced', 'married', 'single', 'widowed'];
  $wrapper->field_marital_status->set($marital_status[$faker->numberBetween(0, count($marital_status) - 1)]);

  $hiv_status = [
    'hiv-exposed-infant',
    'negative',
    'negative-dc',
    'positive',
    'unknown',
  ];
  $wrapper->field_hiv_status->set($hiv_status[$faker->numberBetween(0, count($hiv_status) - 1)]);
  $wrapper->field_household_size->set($faker->numberBetween(0, 30));
  $wrapper->field_number_of_children->set($faker->numberBetween(0, 20));

  $geolocation_info = $helpers['geolocation_info'][$faker->numberBetween(0, count($helpers['geolocation_info']) - 1)];
  $wrapper->field_province->set($geolocation_info[0]);
  $wrapper->field_district->set($geolocation_info[1]);
  $wrapper->field_sector->set($geolocation_info[2]);
  $wrapper->field_cell->set($geolocation_info[3]);
  $wrapper->field_village->set($geolocation_info[4]);

  $wrapper->field_phone_number->set($faker->phoneNumber);
}

/**
 * Generates helper params for participants fields.
 *
 * @return array
 *   Helper params to generate participants fields.
 */
function _hedley_migrate_participant_helpers() {
  return [
    'gender' =>
      ['male', 'female'],
    'geolocation_info' => [
      ['Amajyaruguru', 'Gakenke', 'Busengo', 'Birambo', 'Birambo'],
      ['Amajyaruguru', 'Gakenke', 'Ruli', 'Gikingo', 'Nyamugari'],
      ['Amajyaruguru', 'Gakenke', 'Rushashi', 'Joma', 'Kineza'],
      ['Amajyaruguru', 'Rulindo', 'Burega', 'Butangampundu', 'Kibiraro'],
      ['Amajyaruguru', 'Rulindo', 'Bushoki', 'Mukoto', 'Muko'],
    ],
  ];
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * @param object $node
 *   Site node object.
 */
function _hedley_migrate_preprocess_weight($node) {
  $wrapper = entity_metadata_wrapper('node', $node);

  // Adjust children's weight to realistic figures.
  $wrapper->field_weight->set(rand(1, 60));
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * @param object $node
 *   Site node object.
 */
function _hedley_migrate_preprocess_height($node) {
  $wrapper = entity_metadata_wrapper('node', $node);

  // Adjust children's height to realistic figures.
  $wrapper->field_height->set(rand(30, 160));
}

/**
 * Alters devel generated Sites to satisfy business logic.
 *
 * @param object $node
 *   Site node object.
 */
function _hedley_migrate_preprocess_muac($node) {
  $wrapper = entity_metadata_wrapper('node', $node);

  // Adjust children's height to realistic figures.
  $wrapper->field_muac->set(rand(10, 40));
}
