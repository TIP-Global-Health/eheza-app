<?php

/**
 * @file
 * Code for the Hedley Person feature.
 */

include_once 'hedley_person.features.inc';

define('HEDLEY_PERSON_EDUCATION_NONE', 0);
define('HEDLEY_PERSON_EDUCATION_PRIMARY', 1);
define('HEDLEY_PERSON_EDUCATION_VOCATIONAL', 2);
define('HEDLEY_PERSON_EDUCATION_SECONDARY', 3);
define('HEDLEY_PERSON_EDUCATION_DIPLOMA', 4);
define('HEDLEY_PERSON_EDUCATION_UNIVERSITY', 5);
define('HEDLEY_PERSON_EDUCATION_ADVANCED', 6);

define('HEDLEY_PERSON_GENDER_MALE', 'male');
define('HEDLEY_PERSON_GENDER_FEMALE', 'female');

define('HEDLEY_PERSON_RELATED_BY_PARENT_OF', 'parent');
define('HEDLEY_PERSON_RELATED_BY_CAREGIVER_FOR', 'caregiver');

// Import CSV column mapping:
define('HEDLEY_PERSON_COLUMN_UNIQUE_ID', 0);
define('HEDLEY_PERSON_COLUMN_ADULT_FIRST_NAME', 1);
define('HEDLEY_PERSON_COLUMN_ADULT_SECOND_NAME', 2);
define('HEDLEY_PERSON_COLUMN_ADULT_BIRTH_DATE', 3);
define('HEDLEY_PERSON_COLUMN_ADULT_ESTIMATED', 4);
define('HEDLEY_PERSON_COLUMN_ADULT_NATIONAL_ID', 5);
define('HEDLEY_PERSON_COLUMN_ADULT_GENDER', 6);
define('HEDLEY_PERSON_COLUMN_ADULT_UBUDEHE', 7);
define('HEDLEY_PERSON_COLUMN_ADULT_EDUCATION_LEVEL', 8);
define('HEDLEY_PERSON_COLUMN_ADULT_MARITAL_STATUS', 9);
define('HEDLEY_PERSON_COLUMN_ADULT_HIV_STATUS', 10);
define('HEDLEY_PERSON_COLUMN_ADULT_NUMBER_OF_CHILDREN', 11);
define('HEDLEY_PERSON_COLUMN_ADULT_PHONE', 12);
define('HEDLEY_PERSON_COLUMN_ADULT_PROVINCE', 13);
define('HEDLEY_PERSON_COLUMN_ADULT_DISTRICT', 14);
define('HEDLEY_PERSON_COLUMN_ADULT_SECTOR', 15);
define('HEDLEY_PERSON_COLUMN_ADULT_CELL', 16);
define('HEDLEY_PERSON_COLUMN_ADULT_VILLAGE', 17);
define('HEDLEY_PERSON_COLUMN_ADULT_HEALTH_CENTER', 18);
define('HEDLEY_PERSON_COLUMN_CHILD_FIRST_NAME', 1);
define('HEDLEY_PERSON_COLUMN_CHILD_SECOND_NAME', 2);
define('HEDLEY_PERSON_COLUMN_CHILD_BIRTH_DATE', 3);
define('HEDLEY_PERSON_COLUMN_CHILD_ESTIMATED', 4);
define('HEDLEY_PERSON_COLUMN_CHILD_NATIONAL_ID', 5);
define('HEDLEY_PERSON_COLUMN_CHILD_GENDER', 6);
define('HEDLEY_PERSON_COLUMN_CHILD_UBUDEHE', 7);
define('HEDLEY_PERSON_COLUMN_CHILD_HIV_STATUS', 8);
define('HEDLEY_PERSON_COLUMN_CHILD_MODE_OF_DELIVERY', 9);
define('HEDLEY_PERSON_COLUMN_CHILD_PARENT_NAME', 10);
define('HEDLEY_PERSON_COLUMN_CHILD_RELATIONSHIP', 11);
define('HEDLEY_PERSON_COLUMN_CHILD_PROVINCE', 12);
define('HEDLEY_PERSON_COLUMN_CHILD_DISTRICT', 13);
define('HEDLEY_PERSON_COLUMN_CHILD_SECTOR', 14);
define('HEDLEY_PERSON_COLUMN_CHILD_CELL', 15);
define('HEDLEY_PERSON_COLUMN_CHILD_VILLAGE', 16);
define('HEDLEY_PERSON_COLUMN_CHILD_HEALTH_CENTER', 17);


/**
 * Implementation of hook_menu().
 */
function hedley_person_menu() {
  $items = [];

  $items['admin/content/import'] = [
    'type' => MENU_LOCAL_TASK,
    'title' => 'Import',
    'description' => 'Import participants form spreadsheet on Google Drive',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['hedley_person_import_form'],
    'access callback' => TRUE,
  ];

  return $items;
}

function hedley_person_import_form($form, &$form_state) {
  if (empty($form_state['hidden'])) {
    return hedley_person_get_data_form($form, $form_state);
  }

  switch  ($form_state['hidden']['step']) {
    case 'confirmation':
      return hedley_person_confirmation_form($form, $form_state);

    case 'summary':
      return hedley_person_summary_form($form, $form_state);
  }
}

function hedley_person_get_data_form($form, &$form_state) {
  $form['spreadsheet_id'] = [
    '#title' => 'Please enter Google spreadsheet ID you wish to import',
    '#type' => 'textfield',
//    '#default_value' => '1AywJcgLQIxTDW9k_a_j4sZiRxI76RiPX_VbpeRm2KcU',
    '#default_value' => '1hJ8bo9GNu-6mPf22VYiISle86WMLv0MhF2rXyNJH3O4',
    '#size' => 60,
    '#required' => TRUE,
  ];

  $form['submit_button'] = [
    '#type' => 'submit',
    '#value' => t('Submit'),
  ];

  return $form;
}

function hedley_person_confirmation_form($form, &$form_state) {
  $form['message'] = [
    '#title' => $form_state['hidden']['message'],
    '#type' => 'item',
    '#size' => 60,
  ];

  $form['actions']['submit'] = [
    '#type'   => 'submit',
    '#value'  => t('Yes'),
    '#submit' => ['hedley_person_execute_import'],
    '#limit_validation_errors' => [],
  ];

  $form['actions']['cancel'] = [
    '#type'   => 'submit',
    '#value'  => t('No'),
    '#submit' => ['hedley_person_reset_form'],
    '#limit_validation_errors' => [],
  ];

  return $form;
}

function hedley_person_summary_form($form, &$form_state) {
  $form['message'] = [
    '#title' => $form_state['hidden']['message'],
    '#type' => 'item',
    '#size' => 60,
  ];

  $form['actions']['submit'] = [
    '#type'   => 'submit',
    '#value'  => t('Ok'),
    '#submit' => ['hedley_person_reset_form'],
    '#limit_validation_errors' => [],
  ];

  return $form;
}

function hedley_person_import_form_submit($form, &$form_state) {
  $spreadsheet_id = $form_state['values']['spreadsheet_id'];
  $spreadsheet_uri = "https://docs.google.com/spreadsheets/d/" . $spreadsheet_id . "/export?format=csv";

  $file_content = file_get_contents($spreadsheet_uri);
  if (!$file_content) {
    form_set_error('spreadsheet_id', t('Failed to fetch Google spreadsheet as CSV.'));
    return;
  }

  $spreadsheet_destination = 'temporary://import_' . '_' . date('h-i-s-j-m-Y') . '.csv';
  $file = file_save_data($file_content, $spreadsheet_destination);

  $fp = fopen($file->uri,'r');
  $line = fgets($fp);

  $fields = explode(',', $line);
  $fields_count = count($fields);

  if ($fields_count < 18) {
    form_set_error('spreadsheet_id', t('Fetch CSV file is improperly formatted.'));
    return;
  }

  $patient_type = ($fields[1] == 'Mother Unique ID') ? 'children' : 'adults';
  $patients_count = 0;
  while (($line = fgets($fp)) !== FALSE) {
    $patients_count++;
  }

  fclose($fp);

  $message = 'You are about to import ' . $patients_count . ' ' .  $patient_type . '. Proceed?';

  $form_state['hidden']['message'] = $message;
  $form_state['hidden']['$patient_type'] = $patient_type;
  $form_state['hidden']['file_uri'] = $file->uri;
  $form_state['hidden']['step'] = 'confirmation';
  $form_state['rebuild'] = TRUE;
}

function hedley_person_execute_import($form, &$form_state) {
  $file_uri = $form_state['hidden']['file_uri'];
  $patient_type = $form_state['hidden']['$patient_type'];

  $fp = fopen($file_uri,'r');
  // Skip field names line.
  fgets($fp);

  $failures = [];
  while (($line = fgets($fp)) !== FALSE) {
    $values = explode(',', $line);

    $first_name = $patient_type == 'child' ?
      $values[HEDLEY_PERSON_COLUMN_CHILD_FIRST_NAME] :
      $values[HEDLEY_PERSON_COLUMN_ADULT_FIRST_NAME];

    $second_name = $patient_type == 'child' ?
      $values[HEDLEY_PERSON_COLUMN_CHILD_SECOND_NAME] :
      $values[HEDLEY_PERSON_COLUMN_ADULT_SECOND_NAME];

    if (empty($first_name) && empty($second_name)) {
      $failures[] = $values[HEDLEY_PERSON_COLUMN_UNIQUE_ID];
      continue;
    }

    $node = hedley_person_create_basic_person_node($first_name, $second_name);

    if ($values[HEDLEY_PERSON_COLUMN_UNIQUE_ID] > 4) {
      break;
    }

    $result = $patient_type == 'child' ?
      hedley_person_populate_child_fields($values, $node) :
      hedley_person_populate_adult_fields($values, $node);

    if (!$result) {
      $failures[] = $values[HEDLEY_PERSON_COLUMN_UNIQUE_ID];
    }
  }

  fclose($fp);

  $form_state['hidden']['message'] = 'Dummy import completed';
  $form_state['hidden']['step'] = 'summary';
  $form_state['rebuild'] = TRUE;
}

function hedley_person_reset_form($form, &$form_state) {
  $form_state['hidden'] = [];
  $form_state['rebuild'] = TRUE;
}


function hedley_person_import_form_validate($form, &$form_state) {
}

function hedley_person_create_basic_person_node($first_name, $second_name) {
  global $user;

  $node = new stdClass();
  $node->title = empty($first_name) ? $second_name : $second_name . ' ' . $first_name;
  $node->type = 'person';

  node_object_prepare($node);

  $node->language = LANGUAGE_NONE;
  $node->uid = $user->uid;
  $node->status = 1;
  $node->field_first_name[$node->language][]['value'] = $first_name;
  $node->field_second_name[$node->language][]['value'] = $second_name;

  $node = node_submit($node);
  node_save($node);

  return $node;
}

function hedley_person_populate_adult_fields($values, $node) {
  return;
  $wrapper = entity_metadata_site_wrapper('node', $node);

  $wrapper->field_birth_date->set($values[HEDLEY_PERSON_COLUMN_ADULT_BIRTH_DATE]);
  $wrapper->field_birth_date_estimated->set($values[HEDLEY_PERSON_COLUMN_ADULT_ESTIMATED]);
  $wrapper->field_national_id_number->set($values[HEDLEY_PERSON_COLUMN_ADULT_NATIONAL_ID]);
  $wrapper->field_gender->set($values[HEDLEY_PERSON_COLUMN_ADULT_GENDER]);
  $wrapper->field_ubudehe->set($values[HEDLEY_PERSON_COLUMN_ADULT_UBUDEHE]);
  $wrapper->field_education_level	->set($values[HEDLEY_PERSON_COLUMN_ADULT_EDUCATION_LEVEL]);
  $wrapper->field_marital_status->set($values[HEDLEY_PERSON_COLUMN_ADULT_MARITAL_STATUS]);
  $wrapper->field_hiv_status->set($values[HEDLEY_PERSON_COLUMN_ADULT_HIV_STATUS]);
  $wrapper->field_number_of_children->set($values[HEDLEY_PERSON_COLUMN_ADULT_NUMBER_OF_CHILDREN]);
  $wrapper->field_phone_number->set($values[HEDLEY_PERSON_COLUMN_ADULT_PHONE]);
  $wrapper->field_province->set($values[HEDLEY_PERSON_COLUMN_ADULT_PROVINCE]);
  $wrapper->field_district->set($values[HEDLEY_PERSON_COLUMN_ADULT_DISTRICT]);
  $wrapper->field_sector->set($values[HEDLEY_PERSON_COLUMN_ADULT_SECTOR]);
  $wrapper->field_cell->set($values[HEDLEY_PERSON_COLUMN_ADULT_CELL]);
  $wrapper->field_village->set($values[HEDLEY_PERSON_COLUMN_ADULT_VILLAGE]);


  // Todo: HC
  // $wrapper->field_health_center->set($values[HEDLEY_PERSON_COLUMN_ADULT_]);

  $wrapper->save();

  return TRUE;
}

function hedley_person_populate_child_fields($values, $node) {
  $wrapper = entity_metadata_site_wrapper('node', $node);

  $wrapper->field_birth_date->set($values[HEDLEY_PERSON_COLUMN_CHILD_BIRTH_DATE]);
  $wrapper->field_birth_date_estimated->set($values[HEDLEY_PERSON_COLUMN_CHILD_ESTIMATED]);
  $wrapper->field_national_id_number->set($values[HEDLEY_PERSON_COLUMN_CHILD_NATIONAL_ID]);
  $wrapper->field_gender->set($values[HEDLEY_PERSON_COLUMN_CHILD_GENDER]);
  $wrapper->field_ubudehe->set($values[HEDLEY_PERSON_COLUMN_CHILD_UBUDEHE]);
  $wrapper->field_hiv_status->set($values[HEDLEY_PERSON_COLUMN_CHILD_HIV_STATUS]);
  $wrapper->field_mode_of_delivery->set($values[HEDLEY_PERSON_COLUMN_CHILD_MODE_OF_DELIVERY]);
  $wrapper->field_province->set($values[HEDLEY_PERSON_COLUMN_CHILD_PROVINCE]);
  $wrapper->field_district->set($values[HEDLEY_PERSON_COLUMN_CHILD_DISTRICT]);
  $wrapper->field_sector->set($values[HEDLEY_PERSON_COLUMN_CHILD_SECTOR]);
  $wrapper->field_cell->set($values[HEDLEY_PERSON_COLUMN_CHILD_CELL]);
  $wrapper->field_village->set($values[HEDLEY_PERSON_COLUMN_CHILD_VILLAGE]);

  // Todo: Resoleve mother and create relationship.
//  define('HEDLEY_PERSON_COLUMN_CHILD_PARENT_NAME', 10);
//  define('HEDLEY_PERSON_COLUMN_CHILD_RELATIONSHIP', 11);

  // Todo: HC
  // $wrapper->field_health_center->set($values[HEDLEY_PERSON_COLUMN_ADULT_]);

  $wrapper->save();

  return TRUE;
}
