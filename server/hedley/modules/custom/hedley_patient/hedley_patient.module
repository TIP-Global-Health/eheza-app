<?php

/**
 * @file
 * Code for the Hedley Patient feature.
 */

include_once 'hedley_patient.features.inc';

/**
 * Implements hook_node_insert().
 */
function hedley_patient_node_insert($node) {
  hedley_patient_trigger_pusher_on_item_data_change($node);
}

/**
 * Implements hook_node_update().
 */
function hedley_patient_node_update($node) {
  if (!in_array($node->type, ['mother', 'child'])) {
    return;
  }
  // Make sure we get updated data.
  entity_get_controller('node')->resetCache();
  hedley_patient_trigger_pusher_on_item_data_change($node);
}

/**
 * Trigger a pusher event for a Item data.
 *
 * @param object $node
 *   A Item data node type.
 */
function hedley_patient_trigger_pusher_on_item_data_change($node) {
  if (!in_array($node->type, ['mother', 'child'])) {
    return;
  }

  if ($node->status == NODE_NOT_PUBLISHED) {
    // Node is not published.
    return;
  }

  $account = user_load($node->uid);

  switch ($node->type) {
    case 'child':
      $handler_name = 'children';
      break;

    case 'mother':
      $handler_name = 'mothers';
      break;

  }

  $handler = restful_get_restful_handler($handler_name);
  $handler->setAccount($account);
  $data = $handler->get($node->nid);

  $event_name = 'patient__update';

  hedley_pusher_trigger_event('general', $event_name, $data[0]);
}

/**
 * Implements hook_query_TAG_alter().
 *
 * Add to a query which needs to get all entities without a 'field_relationship'
 * value (is null).
 */
function hedley_patient_query_exclude_existing_relationships_alter(QueryAlterableInterface $query) {
  $query->leftJoin('field_data_field_relationship', 'r', 'node.nid = r.entity_id');
  $query->isNull('r.field_relationship_value');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function hedley_patient_form_mother_node_form_alter(&$form, &$form_state, $form_id) {
  $form['#validate'][] = 'hedley_patient_mother_birth_date_validation';

  $params = drupal_get_query_parameters();

  if (!isset($params['type'])) {
    return;
  }

  if ($params['type'] != 'caregiver') {
    return;
  }

  $form['field_relationship'][LANGUAGE_NONE]['#default_value'] = ['caregiver'];
}

/**
 * Validation callback for mother node form.
 *
 * When the mother node is a caregiver, date of birth is not required.
 */
function hedley_patient_mother_birth_date_validation($form, &$form_state) {
  $relationship_value = $form_state['values']['field_relationship'][LANGUAGE_NONE][0]['value'];
  $birth_date_value = $form_state['values']['field_date_birth'][LANGUAGE_NONE][0]['value'];

  if ($relationship_value == 'mother' && empty($birth_date_value)) {
    form_set_error('field_date_birth', t('The date of birth field is required when adding a mother.'));
  }
}
