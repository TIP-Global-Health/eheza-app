<?php

/**
 * @file
 * Code for the hedley admin feature.
 */

include_once 'hedley_admin.features.inc';

/**
 * Implements hook_menu().
 */
function hedley_admin_menu() {
  $items = [];

  $items['admin/config/hedley-reporting'] = [
    'type' => MENU_LOCAL_TASK,
    'title' => 'Hedley Weekly Reporting',
    'description' => 'Configure Weekly Metrics Report',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['hedley_admin_settings_form'],
    'access arguments' => ['hedley reporting admin'],
  ];

  $items['admin/reports/devices-sync-state'] = array(
    'title' => 'Devices with suspected synchronization issue',
    'description' => 'Presents devices that are suspected to have synchronization issue',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hedley_admin_devices_sync_state_table'),
    'access callback' => 'hedley_admin_administrators_access',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/reports/resilience-survey-report'] = array(
    'title' => 'Resilience Survey Report',
    'description' => 'Presents the Resilience Survey Results',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hedley_admin_resilience_survey_results_table'),
    'access callback' => 'hedley_admin_administrators_access',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Reporting configuration form.
 */
function hedley_admin_settings_form($form, &$form_state) {
  $form['hedley_admin_report_email'] = array(
    '#type' => 'textfield',
    '#title' => t('Email address'),
    '#default_value' => variable_get('hedley_admin_report_email', ''),
    '#description' => t('Leave empty to not allow report-generation for this environment. This email address will receive the report generated by Jenkins.'),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_views_plugins().
 */
function hedley_admin_views_plugins() {
  return array(
    'access' => array(
      'health_center' => array(
        'title' => t('Health-center-based Access'),
        'help' => t('If the child is associated with the same health center as the user, it grants access'),
        'handler' => 'hedley_admin_health_center_access_plugin',
        'path' => drupal_get_path('module', 'hedley_admin'),
      ),
    ),
  );
}

/**
 * Implements preprocess_views_view().
 *
 * Fixes the styling of the date filter form in views.
 */
function hedley_admin_preprocess_views_view(&$vars) {
  // The CSS is very specific that it won't effect anything else and therefore
  // no need to limit it to one view. (Also, this way we don't need to edit
  // anything when adding a date filter to any view).
  drupal_add_css(drupal_get_path('module', 'hedley_admin') . '/css/date_views.css');
}

/**
 * Implements hook_theme_registry_alter().
 */
function hedley_admin_theme_registry_alter(&$theme_registry) {
  $theme_registry['vbo_export_csv']['function'] = 'hedley_admin_vbo_export_csv';
}

/**
 * Csv content builder function.
 */
function hedley_admin_vbo_export_csv($variables) {
  // Sanitize data.
  foreach ($variables['header'] as $key => $item) {
    $variables['header'][$key] = strtr($item, array($variables['separator'] => ' '));
  }

  $content_replacements = array(
    '\r\n' => ' ',
    '\n\r' => ' ',
    '\r' => ' ',
    '\n' => ' ',
    '\t' => ' ',
    $variables['separator'] => ' ',
  );
  foreach ($variables['rows'] as $row_key => $row) {
    foreach ($row as $cell_key => $cell) {
      $variables['rows'][$row_key][$cell_key] = strip_tags(strtr($cell, $content_replacements));
    }
  }

  $handle = fopen('php://temp', 'r+');
  fputcsv($handle, $variables['header']);
  foreach ($variables['rows'] as $row) {
    fputcsv($handle, $row);
  }
  rewind($handle);
  $csv_output = '';
  while (!feof($handle)) {
    $csv_output .= fread($handle, 8192);
  }
  fclose($handle);
  return $csv_output;
}

/**
 * Implements hook_block_info().
 */
function hedley_admin_block_info() {
  $blocks['eheza_app_sidebar_menu'] = [
    'info' => t('E-Heza Admin Menu'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  ];

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function hedley_admin_block_view($delta) {
  if ($delta != 'eheza_app_sidebar_menu') {
    return;
  }

  if (!hedley_admin_administrators_access()) {
    // Only administrators can view the block.
    return;
  }

  $query = db_select('menu_links', 'm');
  $query->fields('m', ['link_path', 'link_title', 'options']);
  $query->condition('menu_name', 'menu-eheza-app-admin-menu');
  $query->orderBy('weight');

  $results = $query->execute()->fetchAll();

  $links = [];
  foreach ($results as $result) {
    $links[] = l($result->link_title, $result->link_path, unserialize($result->options));
  }

  $block = [
    'subject' => t('E-Heza Admin Menu'),
    'content' => [
      '#theme' => 'item_list',
      '#items' => $links,
      '#type' => 'ul',
    ],
  ];

  return $block;
}

/**
 * We do not allow to unpublish content, as it may break syncing.
 *
 * Implements hook_node_update().
 */
function hedley_admin_node_update($node) {
  if (($node->status != NODE_NOT_PUBLISHED) || ($node->original->status != NODE_PUBLISHED)) {
    // We're not unpublishing the node.
    return;
  }

  // Allow to override unpublishing restrictions.
  if (variable_get('hedley_super_user_mode', FALSE)) {
    return;
  }

  throw new Exception('Content unpublishing is forbidden!');
}

/**
 * We do not allow deleting content, as it may break syncing.
 *
 * Implements hook_node_delete().
 */
function hedley_admin_node_delete($node) {
  // Allow to override deletion restrictions.
  if (variable_get('hedley_super_user_mode', FALSE)) {
    return;
  }

  throw new Exception('Content deletion is forbidden!');
}

/**
 * Implements hook_views_pre_view().
 *
 * We would like to propagate the node argument (child)
 * for all the measurements (weight, height, muac), but
 * an URL like ledger/5/5/5 would be ugly.
 * So we propagate the first argument into the other
 * contextual filters by code.
 */
function hedley_admin_views_pre_view(&$view) {
  if ($view->name != 'ledger') {
    return;
  }
  if (empty($view->args[0])) {
    return;
  }
  $view->args[1] = $view->args[0];
  $view->args[2] = $view->args[0];
  $view->args[3] = $view->args[0];
}

/**
 * Implements hook_views_post_execute().
 *
 * Handle special Caregiver field.
 */
function hedley_admin_views_post_execute(&$view) {
  if ($view->name !== 'ledger') {
    return;
  }
  foreach ($view->result as $result) {
    // We have a Caregiver field in the output, where we'd like to simply
    // tell if the given person, displayed in another field, is a mother
    // or a caregiver. So we transform the output of the view to show
    // this boolean outcome.
    if ($result->field_field_related_by[0]['rendered']['#markup'] !== 'Caregiver for') {
      $result->field_field_related_by[0]['rendered']['#markup'] = '';
    }
    else {
      $result->field_field_related_by[0]['rendered']['#markup'] = t('X');
    }
  }

  // Due to the manipulation at hedley_admin_views_pre_view(), we would
  // end up with a very strange breadcrumb, sanitizing it here.
  $breadcrumb = [];
  $breadcrumb[] = l(t('Home'), NULL);
  $breadcrumb[] = l(t('Children'), 'admin/content/children');
  $breadcrumb[] = l(t('Ledger'), 'admin/ledger/' . $view->args[0]);
  drupal_set_breadcrumb($breadcrumb);
}

/**
 * Implements hook_query_TAG_alter().
 *
 * Adds the proper grouping to the ledger.
 */
function hedley_admin_query_views_ledger_alter(QueryAlterableInterface $query) {
  // Modifying the query here, notice the reference handling.
  // @see https://api.drupal.org/api/drupal/includes!database!select.inc/function/SelectQueryInterface%3A%3AgetGroupBy/7.
  $fields =& $query->getGroupBy();
  $fields['node.nid'] = 'node.nid';
}

/**
 * Health-center-based access check.
 */
function hedley_admin_health_center_access($account = FALSE) {
  global $user;

  if (user_is_anonymous()) {
    return FALSE;
  }

  $account = !empty($account) ? $account : $user;
  if ($account->uid == 1) {
    return TRUE;
  }

  if (in_array('administrator', $account->roles)) {
    return TRUE;
  }

  if (!in_array('E-ledger viewer', $account->roles) && !in_array('nurse', $account->roles)) {
    return FALSE;
  }

  // There's no trivial and nice way to pass a view argument.
  // Here views_get_current_view() doesn't return anything.
  // Expected path:
  // /admin/ledger/[nid].
  $nid = arg(2);
  if (empty($nid)) {
    return FALSE;
  }

  $child = node_load($nid);
  if (empty($child)) {
    return FALSE;
  }

  try {
    $child_wrapper = entity_metadata_wrapper('node', $child);
    $account_wrapper = entity_metadata_wrapper('user', $account);
    $child_center_nid = $child_wrapper->field_health_center->getIdentifier();

    if (empty($child_center_nid)) {
      return FALSE;
    }

    $hc_ids = $account_wrapper->field_health_centers->value(['identifier' => TRUE]);
    return in_array($child_center_nid, $hc_ids);
  }
  catch (Exception $e) {
    // Might be impartial data, anyways, simply disallow the access.
    watchdog('hedley_admin', $e->getMessage());
    return FALSE;
  }
}

/**
 * Implements hook_form() for the suspected devices state table.
 *
 * This function generates a table displaying information
 * for devices that are suspected to have a synchronization problem.
 */
function hedley_admin_devices_sync_state_table(array $form, array &$form_state) {
  // Table header definitions.
  $header = array(
    'index' => t('#'),
    'name' => t('Device Name'),
    'to_upload' => [
      'data' => t('Changes to Upload'),
      'class' => 'align-center',
    ],
    'last_sync' => [
      'data' => t('Last Sync Contact'),
      'class' => 'align-center',
    ],
  );

  // SQL query to retrieve synchronization data.
  $query = hedley_general_create_db_select_query_excluding_deleted();
  $query->join('users', 'u', 'u.uid = n.uid');
  $query->join('field_data_field_total_to_upload', 'ttu', 'ttu.entity_id = u.uid');
  $query->join('field_data_field_sync_phase', 'sp', 'sp.entity_id = u.uid');
  $query->addField('u', 'name');
  $query->addField('ttu', 'field_total_to_upload_value');
  $query->addExpression('FROM_UNIXTIME(u.access)', 'last_sync');
  $query->condition('n.type', 'sync_incident');
  $query->condition('sp.field_sync_phase_value', 'sync-start');
  $query->condition('ttu.field_total_to_upload_value', 10, '>');
  $query->condition('u.access', strtotime('-2 months'), '>');
  $query->groupBy('u.name');
  $query->orderBy('last_sync', 'DESC');

  $result = $query->execute();

  $rows = [];
  foreach ($result as $key => $row) {
    $words = explode(' ', $row->name);
    if (end($words) == 'Robot') {
      array_splice($words, -1);
    }

    $rows[] = [
      'index' => $key + 1,
      'name' => implode(' ', $words),
      'to_upload' => [
        'data' => $row->field_total_to_upload_value,
        'class' => 'align-center',
      ],
      'last_sync' => array(
        'data' => $row->last_sync,
        'class' => 'align-center',
      ),
    ];
  }

  $form['table'] = [
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('No data available'),
  ];

  // Add CSS style for center alignment.
  drupal_add_css('.align-center { text-align: center; }', array('type' => 'inline'));

  return $form;
}

/**
 * Allows access to superuser and administrators.
 *
 * @return bool
 *   TRUE if the user has access, FALSE otherwise.
 */
function hedley_admin_administrators_access() {
  if (user_is_anonymous()) {
    return FALSE;
  }

  global $user;

  if ($user->uid == 1) {
    return TRUE;
  }

  $admin_role = user_role_load_by_name('administrator');

  return user_has_role($admin_role->rid);
}

/**
 * Implements hook_form() for generating the Resilience survey results table.
 *
 * This function generates a table displaying the resilience survey results.
 */
function hedley_admin_resilience_survey_results_table(array $form, array &$form_state) {
  $batch_size = 50;
  $offset = 0;

  $header = [
    'nurse' => t('Nurse'),
    'health_center' => t('Health Center'),
    'survey_type' => t('Survey Type'),
    'date_measured' => t('Date Measured'),
  ];
  for ($i = 1; $i <= 12; $i++) {
    $header["question_$i"] = t('Q@number', ['@number' => $i]);
  }

  $base_query = hedley_general_create_entity_field_query_excluding_deleted();
  $base_query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'resilience_survey')
    ->propertyCondition('status', 1);

  $count = clone $base_query;
  $count = $count->count()->execute();

  $rows = [];

  while ($offset < $count) {
    $query = clone $base_query;
    $result = $query->range($offset, $batch_size)->execute();

    if (empty($result['node'])) {
      return [];
    }

    $nodes = node_load_multiple(array_keys($result['node']));
    foreach ($nodes as $node) {
      $nurse_items = field_get_items('node', $node, 'field_nurse');
      $nurse_id = isset($nurse_items[0]['target_id']) ? $nurse_items[0]['target_id'] : NULL;
      $nurse_name = 'Unknown Nurse';

      if ($nurse_id) {
        $nurse_node = node_load($nurse_id);
        $nurse_name = isset($nurse_node->title) ? $nurse_node->title : 'Unknown Nurse';

        $health_center_name = 'Unknown Center';
        $health_center_items = field_get_items('node', $nurse_node, 'field_health_centers');
        $health_center_id = isset($health_center_items[0]['target_id']) ? $health_center_items[0]['target_id'] : NULL;

        if ($health_center_id) {
          $health_center_node = node_load($health_center_id);
          $health_center_name = isset($health_center_node->title) ? $health_center_node->title : 'Unknown Center';
        }
      }
      else {
        $health_center_name = 'Unknown Center';
      }

      $survey_type_items = field_get_items('node', $node, 'field_resilience_survey_type');
      $survey_type = isset($survey_type_items[0]['value']) ? $survey_type_items[0]['value'] : 'Unknown';

      $date_items = field_get_items('node', $node, 'field_date_measured');
      $date_measured = isset($date_items[0]['value']) ? $date_items[0]['value'] : 'Unknown';
      $date_measured = ($date_measured !== 'Unknown') ? date('Y-m-d', strtotime($date_measured)) : 'Unknown';

      $answers_processed = array_fill(1, 12, 'n/a');
      $survey_answers_field = field_get_items('node', $node, 'field_resilience_survey_signs');

      if (!empty($survey_answers_field)) {
        foreach ($survey_answers_field as $item) {
          $answer_pairs = explode('|', $item['value']);
          foreach ($answer_pairs as $answer_pair) {
            $parts = explode('-', $answer_pair);
            if (count($parts) === 2) {
              $question_number = str_replace('q', '', $parts[0]);
              if (is_numeric($question_number)) {
                $answers_processed[$question_number] = is_numeric($parts[1]) ? (int) $parts[1] + 1 : $parts[1];
              }
            }
          }
        }
      }

      $rows[] = [
        'nurse' => $nurse_name,
        'health_center' => $health_center_name,
        'survey_type' => $survey_type,
        'date_measured' => $date_measured,
      ] + $answers_processed;
    }

    $offset += $batch_size;
  }

  $form_state['rows'] = $rows;
  $form['csv_export_button'] = [
    '#type' => 'submit',
    '#value' => t('Export to CSV'),
    '#submit' => ['hedley_admin_resilience_survey_export_csv'],
  ];

  $form['table'] = [
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('No survey results available'),
  ];

  drupal_add_css('.align-center { text-align: center; }', ['type' => 'inline']);
  return $form;
}

/**
 * Custom submit handler to export table data to CSV.
 */
function hedley_admin_resilience_survey_export_csv($form, &$form_state) {
  if (empty($form_state['rows'])) {
    drupal_set_message(t('No data available to export.'), 'error');
    return;
  }

  $rows = $form_state['rows'];
  $filename = 'resilience_survey_results.csv';
  $csv_output = '';

  $header = ['Nurse', 'Health Center', 'Survey Type', 'Date Measured'];
  for ($i = 1; $i <= 12; $i++) {
    $header[] = "Question $i";
  }
  $csv_output .= implode(',', $header) . "\n";

  foreach ($rows as $row) {
    $csv_row = [];
    foreach ($row as $column) {
      $csv_row[] = '"' . str_replace('"', '""', $column) . '"';
    }
    $csv_output .= implode(',', $csv_row) . "\n";
  }

  drupal_add_http_header('Content-Type', 'text/csv; charset=UTF-8');
  drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $filename . '"');
  drupal_add_http_header('Pragma', 'no-cache');
  drupal_add_http_header('Cache-Control', 'must-revalidate, post-check=0, pre-check=0');

  echo $csv_output;
  exit;
}
